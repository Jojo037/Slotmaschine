<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charm Slot Machine (Horizontal/Vertikal Gewinn - ERH√ñHTER GEWINN)</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a;
            color: #f0f0f0;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .game-area, .charm-store {
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        .game-area {
            flex: 2;
            background-color: #333;
        }

        .charm-store {
            flex: 1;
            background-color: #2c2c2c;
            max-height: 800px;
            overflow-y: auto;
        }

        h1, h2, h3 {
            color: #ffd700;
            border-bottom: 2px solid #444;
            padding-bottom: 5px;
            margin-top: 0;
        }

        /* --- SLOT GRID STYLES --- */
        #slotGrid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 5px;
            background-color: #000;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 4px solid #555;
        }

        .reel-cell {
            width: 100%;
            height: 80px; /* Feste H√∂he */
            background-color: #222;
            border: 1px solid #444;
            border-radius: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 4em;
            overflow: hidden; /* Wichtig, um den rollenden Effekt zu erm√∂glichen */
            position: relative; /* F√ºr die Positionierung des inneren Elements */
        }
        
        /* Das innere Element, das animiert wird */
        .reel-inner {
            display: block; /* Wichtig f√ºr vertikale Ausrichtung */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            text-align: center;
            line-height: 80px; /* Jedes Symbol nimmt 80px H√∂he ein */
            font-size: 1em; 
            
            /* Neue Transition f√ºr das sanfte Abbremsen */
            transition: transform 0.5s cubic-bezier(0.25, 0.1, 0.25, 1), filter 0.2s;
        }
        
        /* NEUE CSS F√úR DEN DREH-EFFEKT (ANIMATION) */
        /* Keyframes f√ºr den schnellen, unendlichen Spin */
        @keyframes fast-spin {
            100% { transform: translateY(-4000px); } /* Sehr weite Strecke, um unendlich zu wirken */
        }

        .spinning {
            /* Bewegungs-Unsch√§rfe (Blur) w√§hrend des Spins */
            filter: blur(5px);
        }
        
        .spinning .reel-inner {
            /* Der schnelle Roll-Teil */
            animation: fast-spin 0.1s linear infinite;
        }


        .win-highlight {
            border: 3px solid #ff4500;
            box-shadow: 0 0 10px #ff4500;
        }

        /* --- INFO & CONTROLS --- */
        .info-panel {
            background-color: #222;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 5px solid #00aaff;
        }

        .info-panel p {
            margin: 5px 0;
            font-size: 1.1em;
        }

        #balance, #charmPoints, #consecutiveLossesDisplay, #currentBet {
            font-weight: bold;
            color: #00ff88;
        }
        
        #prestigeLevelDisplay {
            color: #ff9900;
            font-weight: bold;
        }
        
        #prestigeTimerDisplay, #bestTimeDisplay {
             font-size: 0.9em;
             color: #aaa;
        }

        #message {
            background-color: #444;
            padding: 10px;
            border-radius: 6px;
            min-height: 20px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s, transform 0.1s;
            margin: 5px;
        }

        #spinButton {
            background-color: #4CAF50;
            color: white;
            font-size: 1.2em;
        }

        #spinButton:hover:not(:disabled) {
            background-color: #45a049;
            transform: scale(1.02);
        }

        #spinButton:disabled {
            background-color: #666;
            cursor: not-allowed;
        }
        
        #prestigeButton {
            background-color: #ff9900;
            color: black;
            font-size: 1em;
            width: 100%;
        }

        #prestigeButton:disabled {
            background-color: #666;
        }

        /* --- CHARM STORE STYLES --- */
        .charm-item {
            background-color: #383838;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            border-left: 4px solid #8a2be2;
        }

        .charm-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .charm-header strong {
            font-size: 1.1em;
            color: #fff;
        }

        .charm-status {
            font-weight: bold;
            color: #00ff88;
        }
        
        .charm-status.max {
            color: #ffd700;
        }

        .charm-item button {
            background-color: #8a2be2;
            color: white;
            padding: 8px;
            margin-top: 10px;
        }
        
        .charm-item button:disabled {
            background-color: #666;
        }
        
        #charmDescription {
            background-color: #222;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            min-height: 50px;
            font-size: 0.9em;
            color: #ccc;
        }
        
        #boostSelectorDiv {
            padding: 10px;
            background-color: #444;
            border-radius: 8px;
            margin-top: 10px;
            display: none; /* Initial versteckt */
        }
        
        #boostSymbolSelector {
            padding: 5px;
            border-radius: 4px;
        }

    </style>
</head>
<body>

    <h1>üé∞ Charm Slot Machine üßô‚Äç‚ôÇÔ∏è</h1>
    <div id="message">Willkommen! Starte mit 1000 Credits.</div>

    <div class="container">
        
        <div class="game-area">
            
            <div class="info-panel">
                <p>Guthaben: <span id="balance">1000</span> Credits</p>
                <p>Einsatz pro Spin: <span id="currentBet">100</span> Credits</p>
                <p>Charm-Punkte: <span id="charmPoints">0</span> P</p>
                <p>Nieten in Folge: <span id="consecutiveLossesDisplay">0</span></p>
                <p id="prestigeLevelDisplay">Prestige Level: 0 (Bonus: +0%)</p>
                <p id="prestigeTimerDisplay">‚è±Ô∏è Zeit bis Prestige: Nicht gestartet</p>
                <p id="bestTimeDisplay"></p>
            </div>
            
            <div id="slotGrid">
                </div>

            <button id="spinButton" onclick="spin()">DREHEN (100 Credits)</button>
            <button onclick="resetGame()">Spiel neustarten</button>
            
            <div id="boostSelectorDiv">
                <h3>Anti-Niete Boost Symbol</h3>
                <p>Aktuelles Boost-Symbol: <span id="boostedSymbolDisplay">üçí</span></p>
                <select id="boostSymbolSelector" onchange="setBoostSymbol(this.value)"></select>
            </div>

        </div>

        <div class="charm-store">
            <h2>‚ú® Charm Shop</h2>
            <p>Klicke auf einen Charm, um die Beschreibung zu sehen!</p>
            <div id="charmDescription"></div>
            
            <button id="prestigeButton" onclick="activatePrestige()">PRESTIGE AKTIVIEREN (10000 P ben√∂tigt)</button>
            
            <h3>Permanente Charms</h3>
            
            <div class="charm-item" onmouseover="showPermanentCharmInfo('luckyStart')" onmouseout="clearCharmInfo()">
                <div class="charm-header">
                    <strong>Lucky Start (Lvl <span id="statusLuckyStart">0</span>)</strong>
                    <span class="charm-status">üçí Start</span>
                </div>
                <button id="buyLuckyStart" onclick="buyPermanentCharm('luckyStart')">KAUFEN/UPGRADE (100 P)</button>
            </div>

            <div class="charm-item" onmouseover="showPermanentCharmInfo('doubleDiamond')" onmouseout="clearCharmInfo()">
                <div class="charm-header">
                    <strong>Double Diamond (Lvl <span id="statusDoubleDiamond">0</span>)</strong>
                    <span class="charm-status">üíé H√§ufigkeit</span>
                </div>
                <button id="buyDoubleDiamond" onclick="buyPermanentCharm('doubleDiamond')">KAUFEN/UPGRADE (200 P)</button>
            </div>

            <div class="charm-item" onmouseover="showPermanentCharmInfo('antiLossBoost')" onmouseout="clearCharmInfo()">
                <div class="charm-header">
                    <strong>Anti-Loss Boost (Lvl <span id="statusAntiLossBoost">0</span>)</strong>
                    <span class="charm-status">üö´ Niete Schutz</span>
                </div>
                <button id="buyAntiLossBoost" onclick="buyPermanentCharm('antiLossBoost')">KAUFEN/UPGRADE (300 P)</button>
            </div>
            
            <div class="charm-item" onmouseover="showPermanentCharmInfo('charmMastery')" onmouseout="clearCharmInfo()">
                <div class="charm-header">
                    <strong>Charm Mastery (Lvl <span id="statusCharmMastery">0</span>)</strong>
                    <span class="charm-status">‚≠ê Min. Pkt</span>
                </div>
                <button id="buyCharmMastery" onclick="buyPermanentCharm('charmMastery')">KAUFEN/UPGRADE (350 P)</button>
            </div>
            
            <div class="charm-item" onmouseover="showPermanentCharmInfo('puritySevens')" onmouseout="clearCharmInfo()">
                <div class="charm-header">
                    <strong>Purity Sevens (Lvl <span id="statusPuritySevens">0</span>)</strong>
                    <span class="charm-status">7Ô∏è‚É£ Bonus</span>
                </div>
                <button id="buyPuritySevens" onclick="buyPermanentCharm('puritySevens')">KAUFEN/UPGRADE (500 P)</button>
            </div>

            <div class="charm-item" onmouseover="showPermanentCharmInfo('wildGem')" onmouseout="clearCharmInfo()">
                <div class="charm-header">
                    <strong>Wild Gem (Lvl <span id="statusWildGem">0</span>)</strong>
                    <span class="charm-status">üíé WILD</span>
                </div>
                <button id="buyWildGem" onclick="buyPermanentCharm('wildGem')">KAUFEN/UPGRADE (400 P)</button>
            </div>
            
            <div class="charm-item" onmouseover="showPermanentCharmInfo('lossStreakProtection')" onmouseout="clearCharmInfo()">
                <div class="charm-header">
                    <strong>Loss Streak Protection (Lvl <span id="statusLossStreakProtection">0</span>)</strong>
                    <span class="charm-status">üõ°Ô∏è Z√§hler</span>
                </div>
                <button id="buyLossStreakProtection" onclick="buyPermanentCharm('lossStreakProtection')">KAUFEN/UPGRADE (550 P)</button>
            </div>
            
            <div class="charm-item" onmouseover="showPermanentCharmInfo('luckyMoney')" onmouseout="clearCharmInfo()">
                <div class="charm-header">
                    <strong>Lucky Money (Lvl <span id="statusLuckyMoney">0</span>)</strong>
                    <span class="charm-status">üí∞ Pkt zu C</span>
                </div>
                <button id="buyLuckyMoney" onclick="buyPermanentCharm('luckyMoney')">KAUFEN/UPGRADE (450 P)</button>
            </div>
            
            <div class="charm-item" onmouseover="showPermanentCharmInfo('freeUpgrade')" onmouseout="clearCharmInfo()">
                <div class="charm-header">
                    <strong>Free Upgrade (Lvl <span id="statusFreeUpgrade">0</span>)</strong>
                    <span class="charm-status">üìà Gewinnserie</span>
                </div>
                <button id="buyFreeUpgrade" onclick="buyPermanentCharm('freeUpgrade')">KAUFEN/UPGRADE (600 P)</button>
            </div>
            
             <div class="charm-item" onmouseover="showPermanentCharmInfo('consolationPrize')" onmouseout="clearCharmInfo()">
                <div class="charm-header">
                    <strong>Consolation Prize (Lvl <span id="statusConsolationPrize">0</span>)</strong>
                    <span class="charm-status">üí∏ Refund</span>
                </div>
                <button id="buyConsolationPrize" onclick="buyPermanentCharm('consolationPrize')">KAUFEN/UPGRADE (650 P)</button>
            </div>
            
            <div class="charm-item" onmouseover="showPermanentCharmInfo('wealthBlessing')" onmouseout="clearCharmInfo()">
                <div class="charm-header">
                    <strong>Wealth Blessing (Lvl <span id="statusWealthBlessing">0</span>)</strong>
                    <span class="charm-status">üè¶ Guthaben Pkt</span>
                </div>
                <button id="buyWealthBlessing" onclick="buyPermanentCharm('wealthBlessing')">KAUFEN/UPGRADE (700 P)</button>
            </div>
            
            <div class="charm-item" onmouseover="showPermanentCharmInfo('lastChance')" onmouseout="clearCharmInfo()">
                <div class="charm-header">
                    <strong>Last Chance (Lvl <span id="statusLastChance">0</span>)</strong>
                    <span class="charm-status">üõë Einmalig</span>
                </div>
                <button id="buyLastChance" onclick="buyPermanentCharm('lastChance')">KAUFEN (800 P)</button>
            </div>

            <div class="charm-item" onmouseover="showPermanentCharmInfo('speedBlessing')" onmouseout="clearCharmInfo()">
                <div class="charm-header">
                    <strong>Speed Blessing (Lvl <span id="statusSpeedBlessing">0</span>)</strong>
                    <span class="charm-status">‚è±Ô∏è Spin Speed</span>
                </div>
                <button id="buySpeedBlessing" onclick="buyPermanentCharm('speedBlessing')">KAUFEN/UPGRADE (380 P)</button>
            </div>

        </div>
    </div>

    <script>
        // --- JAVASCRIPT LOGIK (PAYOUTS ERH√ñHT) ---
        let initialBalance = 1000;
        let balance = 1000;
        let charmPoints = 0;
        let consecutiveLosses = 0;
        let consecutiveWins = 0;
        let lastChanceUsed = false;
        let prestigeLevel = 0;
        let prestigeMultiplier = 0.0;
        let prestigeStartTime = null;
        let isTimingPrestige = false;
        let isSpinning = false; // Neu: Flag, um Doppelklicks zu verhindern

        const lineBet = 10;
        const totalBet = 10 * lineBet; 

        // Basis-Symbole: 10 Symbole
        const symbols = ['üçí', 'üçí', 'üçí', 'üçã', 'üçã', 'üíé', 'üîî', 'üîî', '‚≠ê', '7Ô∏è‚É£'];
        const NUM_ROWS = 3;
        const NUM_REELS = 5;
        const MAX_CHARM_LEVEL = 3;
        const PRESTIGE_COST = 10000;
        const SYMBOL_HEIGHT = 80; 

        let permanentCharms = {
            luckyStart: 0, doubleDiamond: 0, antiLossBoost: 0,
            boostSymbol: 'üçí', charmMastery: 0, puritySevens: 0, wildGem: 0,
            lossStreakProtection: 0, luckyMoney: 0, freeUpgrade: 0,
            consolationPrize: 0, wealthBlessing: 0, lastChance: 0, speedBlessing: 0
        };

        const CHARM_DATA = {
            // ... (CHARM_DATA bleibt unver√§ndert) ...
            luckyStart: {
                cost: [100, 200, 400],
                desc: [
                    "Garantiert eine Kirsche (üçí) auf der ersten Walze in der Mitte.",
                    "Garantiert eine Kirsche (üçí) auf der ersten **und zweiten** Walze in der Mitte.",
                    "Garantiert eine **Zitrone (üçã)** auf der ersten und zweiten Walze in der Mitte."
                ]
            },
            doubleDiamond: {
                cost: [200, 300, 500],
                desc: [
                    "Diamanten (üíé) erscheinen √∂fter auf den Walzen.",
                    "Diamanten erscheinen **noch** √∂fter auf den Walzen (+2 Symbole).",
                    "Diamanten erscheinen **sehr viel** √∂fter auf den Walzen (+4 Symbole)."
                ]
            },
            antiLossBoost: {
                cost: [300, 500, 800],
                desc: [
                    "Nach 3 Nieten gibt der n√§chste Spin 3x dein Boost-Symbol in der Mitte.",
                    "Nach 3 Nieten gibt der n√§chste Spin **4x** dein Boost-Symbol in der Mitte.",
                    "Nach 3 Nieten gibt der n√§chste Spin **5x** dein Boost-Symbol in der Mitte (Garantierter 5er-Win)."
                ]
            },
            charmMastery: {
                cost: [350, 550, 750],
                desc: [
                    "Du gewinnst immer mindestens **10** Charm-Punkte pro Spin (statt 5).",
                    "Du gewinnst immer mindestens **15** Charm-Punkte pro Spin.",
                    "Du gewinnst immer mindestens **20** Charm-Punkte pro Spin."
                ]
            },
            puritySevens: {
                cost: [500, 700, 900],
                desc: [
                    "Wenn du nur mit 7Ô∏è‚É£-Symbolen gewinnst, wird der Gewinn **verdoppelt**.",
                    "Wenn du nur mit 7Ô∏è‚É£-Symbolen gewinnst, wird der Gewinn **verdreifacht (x3)**.",
                    "Wenn du nur mit 7Ô∏è‚É£-Symbolen gewinnst, wird der Gewinn **vervierfacht (x4)**."
                ]
            },
            wildGem: {
                cost: [400, 600, 800],
                desc: [
                    "Das Diamant-Symbol (üíé) ersetzt andere Symbole (au√üer 7Ô∏è‚É£) f√ºr Gewinne.",
                    "Diamant (üíé) ersetzt nun **alle** Symbole (auch 7Ô∏è‚É£) f√ºr Gewinne.",
                    "Diamant (üíé) ersetzt alle Symbole **und erh√∂ht den Liniengewinn um 10%**."
                ]
            },
            lossStreakProtection: {
                cost: [550, 750, 950],
                desc: [
                    "Nach einem Anti-Niete Boost wird der Nieten-Z√§hler nur auf **1** (statt 0) zur√ºckgesetzt.",
                    "Nach einem Anti-Niete Boost wird der Nieten-Z√§hler nur auf **2** zur√ºckgesetzt.",
                    "Nach einem Anti-Niete Boost wird der Nieten-Z√§hler auf **0** zur√ºckgesetzt **und du erh√§ltst 50 Credits**."
                ]
            },
            luckyMoney: {
                cost: [450, 650, 850],
                desc: [
                    "Du gewinnst pro Spin zus√§tzlich 1 Credit pro 1 Charm-Punkt (max. 200 Credits).",
                    "Du gewinnst pro Spin zus√§tzlich 1.5 Credits pro 1 Charm-Punkt (max. 300 Credits).",
                    "Du gewinnst pro Spin zus√§tzlich 2 Credits pro 1 Charm-Punkt (max. 400 Credits)."
                ]
            },
            freeUpgrade: {
                cost: [600, 800, 1000],
                desc: [
                    "Wenn du 10 Spins in Folge gewinnst, erh√§ltst du **100 Charm-Punkte**.",
                    "Wenn du 5 Spins in Folge gewinnst, erh√§ltst du **100 Charm-Punkte**.",
                    "Wenn du 3 Spins in Folge gewinnst, erh√§ltst du **100 Charm-Punkte**."
                ]
            },
            consolationPrize: {
                cost: [650, 850, 1050],
                desc: [
                    "Jede Niete gibt dir **10 Credits** zur√ºck.",
                    "Jede Niete gibt dir **20 Credits** zur√ºck.",
                    "Jede Niete gibt dir **30 Credits** zur√ºck."
                ]
            },
            wealthBlessing: {
                cost: [700, 900, 1100],
                desc: [
                    "Du erh√§ltst pro Spin +1 Charm-Punkt f√ºr jede 50 Credits Guthaben.",
                    "Du erh√§ltst pro Spin +1.5 Charm-Punkte f√ºr jede 50 Credits Guthaben.",
                    "Du erh√§ltst pro Spin +2 Charm-Punkte f√ºr jede 50 Credits Guthaben."
                ]
            },
            lastChance: {
                cost: [800, 0, 0],
                desc: [
                    "Wenn dein Guthaben unter den Einsatz f√§llt, bekommst du **einmalig 500 Credits** zur√ºck.",
                    "Bereits gekauft und eingesetzt.",
                    "Bereits gekauft und eingesetzt."
                ]
            },
            speedBlessing: {
                cost: [380, 580, 780],
                desc: [
                    "**Halbiert** die Drehzeit der Walzen (Spin geht schneller).",
                    "Reduziert die Drehzeit der Walzen um **70%**.",
                    "Reduziert die Drehzeit der Walzen um **85%** (Fast sofort)."
                ]
            }
        };

        const balanceDisplay = document.getElementById('balance');
        const charmPointsDisplay = document.getElementById('charmPoints');
        const messageDisplay = document.getElementById('message');
        const spinButton = document.getElementById('spinButton');
        const slotGrid = document.getElementById('slotGrid');
        const charmDescriptionDisplay = document.getElementById('charmDescription');
        const consecutiveLossesDisplay = document.getElementById('consecutiveLossesDisplay');
        const boostedSymbolDisplay = document.getElementById('boostedSymbolDisplay');
        const boostSymbolSelector = document.getElementById('boostSymbolSelector');
        const boostSelectorDiv = document.getElementById('boostSelectorDiv');
        const prestigeButton = document.getElementById('prestigeButton');
        const prestigeLevelDisplay = document.getElementById('prestigeLevelDisplay');
        const prestigeTimerDisplay = document.getElementById('prestigeTimerDisplay');
        const bestTimeDisplay = document.getElementById('bestTimeDisplay');

        const statusElements = {};
        for (const key in permanentCharms) {
            statusElements[`status${key.charAt(0).toUpperCase() + key.slice(1)}`] = document.getElementById(`status${key.charAt(0).toUpperCase() + key.slice(1)}`);
        }

        const buyButtons = {};
        for (const key in permanentCharms) {
            buyButtons[`buy${key.charAt(0).toUpperCase() + key.slice(1)}`] = document.getElementById(`buy${key.charAt(0).toUpperCase() + key.slice(1)}`);
        }


        let reelElements = [];
        let slotResult = Array(NUM_ROWS).fill(0).map(() => Array(NUM_REELS).fill('?')); 


        // Die Diagonalen Linien werden nicht f√ºr die Gewinnberechnung verwendet, 
        // da nur Horizontale und Vertikale Reihen gew√ºnscht sind.
        const DIAGONAL_PAY_LINES = [
            [1, 1, 1, 1, 1], [0, 0, 0, 0, 0], [2, 2, 2, 2, 2], [0, 1, 2, 1, 0], 
            [2, 1, 0, 1, 2], [0, 0, 1, 2, 2], [2, 2, 1, 0, 0], [1, 0, 1, 2, 1], 
            [1, 2, 1, 0, 1], [0, 1, 0, 1, 0]
        ];

        // Auszahlungen pro Linieneinsatz (LineBet = 10 Credits)
        // [3er-Win, 4er-Win, 5er-Win]
        // ERH√ñHTER GEWINN: +20 Credits auf jeden Basis-Gewinn
        const PAYOUTS = {
            'üçí': [25, 30, 45], // War [5, 10, 25]
            'üçã': [25, 30, 45], // War [5, 10, 25]
            'üíé': [30, 40, 70], // War [10, 20, 50]
            'üîî': [30, 40, 70], // War [10, 30, 75] -> Hier war die 4er Auszahlung zuvor h√∂her, jetzt angepasst.
            '‚≠ê': [40, 70, 170], // War [20, 50, 150]
            '7Ô∏è‚É£': [70, 120, 320], // War [50, 100, 300]
            'X': [22, 25, 30] // Mix-Symbole (Platzhalter) - Auch erh√∂ht
        };


        // 1. ANZEIGE-FUNKTIONEN
        // ----------------------

        function createSlotField() {
            if (slotGrid.children.length > 0) return;

            for (let row = 0; row < NUM_ROWS; row++) {
                for (let reel = 0; reel < NUM_REELS; reel++) {
                    const cellDiv = document.createElement('div');
                    cellDiv.className = 'reel-cell';
                    cellDiv.id = `cell-${row}-${reel}`;
                    
                    // Neues inneres Element f√ºr die Animation
                    const innerDiv = document.createElement('div');
                    innerDiv.className = 'reel-inner';
                    innerDiv.textContent = '?'; 
                    cellDiv.appendChild(innerDiv);
                    
                    slotGrid.appendChild(cellDiv);
                    reelElements.push(cellDiv);
                }
            }
        }

        function populateBoostSelector() {
            const uniqueSymbols = [...new Set(symbols)];
            uniqueSymbols.forEach(symbol => {
                const option = document.createElement('option');
                option.value = symbol;
                option.textContent = symbol;
                boostSymbolSelector.appendChild(option);
            });
            boostSymbolSelector.value = permanentCharms.boostSymbol;
        }

        // 2. HILFSFUNKTIONEN
        // ------------------

        function formatTime(ms) {
            if (ms === 0) return '00h 00m 00s';
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            const h = hours.toString().padStart(2, '0');
            const m = minutes.toString().padStart(2, '0');
            const s = seconds.toString().padStart(2, '0');
            
            return `${h}h ${m}m ${s}s`;
        }

        function getAdjustedSymbols() {
            let currentSymbols = [...symbols];
            // Double Diamond Charm
            if (permanentCharms.doubleDiamond === 1) {
                currentSymbols.push('üíé');
            } else if (permanentCharms.doubleDiamond === 2) {
                currentSymbols.push('üíé', 'üíé');
            } else if (permanentCharms.doubleDiamond === 3) {
                currentSymbols.push('üíé', 'üíé', 'üíé', 'üíé');
            }
            return currentSymbols;
        }

        function getRandomSymbol() {
            const adjustedSymbols = getAdjustedSymbols();
            const randomIndex = Math.floor(Math.random() * adjustedSymbols.length);
            return adjustedSymbols[randomIndex];
        }

        function getSpinDuration() {
            const baseDuration = 3000; // 3.0 Sekunden Basis-Spin-Dauer (ms) f√ºr die gesamte Animation
            switch (permanentCharms.speedBlessing) {
                case 1: return baseDuration * 0.5; // 50% Reduktion
                case 2: return baseDuration * 0.3; // 70% Reduktion
                case 3: return baseDuration * 0.15; // 85% Reduktion
                default: return baseDuration;
            }
        }


        // 3. HAUPTSPIEL-LOGIK
        // -------------------

        function generateSlotResult() {
            let result = Array(NUM_ROWS).fill(0).map(() => Array(NUM_REELS).fill(null));
            
            // 1. Apply Anti-Loss Boost (Anti-Niete Boost)
            if (permanentCharms.antiLossBoost > 0 && consecutiveLosses >= 3) {
                const boostSymbol = permanentCharms.boostSymbol;
                const boostReels = permanentCharms.antiLossBoost; 
                
                for (let reel = 0; reel < NUM_REELS; reel++) {
                    if (reel < boostReels) {
                        result[1][reel] = boostSymbol; // Setze Boost-Symbol in die Mitte
                    } else {
                        result[1][reel] = getRandomSymbol();
                    }
                    // F√ºlle Rest der Walzen zuf√§llig, um einen "echten" Spin zu simulieren
                    for (let row = 0; row < NUM_ROWS; row++) {
                        if (result[row][reel] === null) {
                            result[row][reel] = getRandomSymbol();
                        }
                    }
                }
                
                // Anti-Niete wurde ausgel√∂st, Z√§hler zur√ºcksetzen
                if (permanentCharms.lossStreakProtection === 1) {
                    consecutiveLosses = 1;
                } else if (permanentCharms.lossStreakProtection === 2) {
                    consecutiveLosses = 2;
                } else if (permanentCharms.lossStreakProtection === 3) {
                    consecutiveLosses = 0; // Level 3 gibt 50 Credits Bonus!
                    balance += 50;
                    messageDisplay.textContent += " (+50 Credits Schutz-Bonus!)";
                } else {
                    consecutiveLosses = 0;
                }
                updateAllDisplays();
                return result;
            }

            // 2. Apply Lucky Start Charm (Gl√ºcklicher Start)
            if (permanentCharms.luckyStart >= 1) {
                let symbolToPlace = 'üçí';
                let reelsToPlace = 1;

                if (permanentCharms.luckyStart === 2) {
                    reelsToPlace = 2;
                } else if (permanentCharms.luckyStart === 3) {
                    symbolToPlace = 'üçã';
                    reelsToPlace = 2;
                }

                for (let reel = 0; reel < reelsToPlace; reel++) {
                    result[1][reel] = symbolToPlace; // Setze Symbol in die Mitte
                }
            }
            
            // 3. F√ºlle den Rest zuf√§llig
            for (let row = 0; row < NUM_ROWS; row++) {
                for (let reel = 0; reel < NUM_REELS; reel++) {
                    if (result[row][reel] === null) {
                        result[row][reel] = getRandomSymbol();
                    }
                }
            }

            return result;
        }

        function calculateWin(result) {
            let totalWin = 0;
            let winningCells = [];
            let isPureSevensWin = true;
            let didWin = false;

            // Funktion zum Abrufen des Symbols und Ber√ºcksichtigung von Wilds
            const getSymbol = (row, reel) => {
                const symbol = result[row][reel];
                // Wild Gem Level 1: Diamant ersetzt alles au√üer 7Ô∏è‚É£
                if (permanentCharms.wildGem === 1 && symbol === 'üíé') return 'WILD';
                // Wild Gem Level 2/3: Diamant ersetzt alles
                if (permanentCharms.wildGem >= 2 && symbol === 'üíé') return 'WILD_7';
                return symbol;
            };
            
            const getBaseSymbol = (row, reel) => result[row][reel];

            // --- HILFSFUNKTION: PR√úFT EINE GENERISCHE LINIE ---
            function checkLine(lineCoords) {
                if (lineCoords.length < 3) return { win: 0, cells: [], isPure: false };

                let currentSymbol = getSymbol(lineCoords[0][0], lineCoords[0][1]);
                let count = 1;
                let lineWinningCells = [[lineCoords[0][0], lineCoords[0][1]]];
                let lineSymbols = [getBaseSymbol(lineCoords[0][0], lineCoords[0][1])];

                for (let i = 1; i < lineCoords.length; i++) {
                    const [row, reel] = lineCoords[i];
                    const nextSymbol = getSymbol(row, reel);
                    const nextBaseSymbol = getBaseSymbol(row, reel);
                    
                    // Behandlung von Wilds (Logik wie zuvor)
                    if (currentSymbol === 'WILD' || currentSymbol === 'WILD_7') {
                        if (nextSymbol !== 'WILD' && nextSymbol !== 'WILD_7' && (currentSymbol !== 'WILD' || nextSymbol !== '7Ô∏è‚É£')) {
                            currentSymbol = nextSymbol;
                        }
                    } else if (nextSymbol === 'WILD') {
                        if (currentSymbol !== '7Ô∏è‚É£') {
                            // Z√§hlt als Match, da Wild nur 7er ausschlie√üt
                        } else {
                            break; 
                        }
                    } else if (nextSymbol === 'WILD_7') {
                        // Wild_7 ersetzt alles
                    } else if (currentSymbol !== nextSymbol) {
                        break;
                    }
                    
                    count++;
                    lineWinningCells.push([row, reel]);
                    lineSymbols.push(nextBaseSymbol);
                }

                if (count >= 3) {
                    const payout = PAYOUTS[currentSymbol] ? PAYOUTS[currentSymbol][count - 3] : PAYOUTS['X'][count - 3];
                    let winAmount = payout * lineBet;

                    // Wild Gem Level 3 Bonus
                    if (permanentCharms.wildGem === 3 && lineSymbols.includes('üíé')) {
                        winAmount *= 1.10;
                    }
                    
                    // Prestige Multiplier
                    winAmount *= (1 + prestigeMultiplier);
                    
                    // isPure ist nur relevant, wenn es sich um eine 5er-Linie handelt
                    const isPure = lineSymbols.filter(s => s !== '7Ô∏è‚É£').length === 0 && lineCoords.length === NUM_REELS; 
                    
                    return { win: Math.round(winAmount), cells: lineWinningCells, isPure: isPure };
                }
                
                return { win: 0, cells: [], isPure: false };
            }
            // --- ENDE HILFSFUNKTION ---


            // *** 1. Horizontale Linien (Alle Reihen) pr√ºfen (3 Linien) ***
            for (let row = 0; row < NUM_ROWS; row++) {
                // Horizontale Linie: [[row, 0], [row, 1], [row, 2], [row, 3], [row, 4]]
                const lineCoords = Array.from({ length: NUM_REELS }, (_, reel) => [row, reel]);
                const { win, cells, isPure } = checkLine(lineCoords);
                
                if (win > 0) {
                    totalWin += win;
                    winningCells.push(...cells);
                    didWin = true;
                    // Wenn wir gewinnen, aber die Linie keine Pure-Sevens-5er-Linie ist, wird der Bonus unterbrochen
                    if (!isPure) isPureSevensWin = false; 
                } else {
                    // Eine Niete auf dieser Linie bedeutet noch nicht, dass der gesamte Lauf kein Purity Sevens ist.
                    // Nur die Gewinne z√§hlen f√ºr den Bonus.
                }
            }

            // *** 2. Vertikale Linien (Alle Spalten) pr√ºfen (5 Linien) ***
            for (let reel = 0; reel < NUM_REELS; reel++) {
                // Vertikale Linie: [[0, reel], [1, reel], [2, reel]] (Kann nur 3er-Gewinne haben)
                const lineCoords = Array.from({ length: NUM_ROWS }, (_, row) => [row, reel]);
                const { win, cells } = checkLine(lineCoords); 
                
                if (win > 0) {
                    totalWin += win;
                    winningCells.push(...cells);
                    didWin = true;
                    // Vertikale Linien unterbrechen den Purity Sevens Bonus, da sie keine 5er-Linien sind
                    isPureSevensWin = false; 
                }
            }
            
            // Purity Sevens Charm
            if (didWin && isPureSevensWin && permanentCharms.puritySevens > 0) {
                const multiplier = permanentCharms.puritySevens + 1;
                totalWin *= multiplier;
                messageDisplay.textContent += ` (üî• Siebener-Bonus: x${multiplier}!)`;
            }

            // Entferne Duplikate aus den hervorgehobenen Zellen
            const uniqueWinningCells = Array.from(new Set(winningCells.map(JSON.stringify)), JSON.parse);

            return { totalWin: Math.round(totalWin), winningCells: uniqueWinningCells, didWin };
        }

        window.spin = function() {
            if (isSpinning) return;
            if (balance < totalBet) {
                // Last Chance Charm (Letzte Chance)
                if (permanentCharms.lastChance === 1 && !lastChanceUsed) {
                    lastChanceUsed = true;
                    balance += 500;
                    messageDisplay.textContent = `üö´ Guthaben zu niedrig! Aber 'Letzte Chance' hat dir 500 Credits gegeben!`;
                    updateAllDisplays();
                    // Deaktiviere den Kauf-Button, wenn er bereits aktiviert ist
                    if (buyButtons.buyLastChance) {
                        buyButtons.buyLastChance.disabled = true;
                        buyButtons.buyLastChance.textContent = 'BEREITS EINGESETZT';
                    }
                    return;
                }
                messageDisplay.textContent = 'üö´ Nicht genug Credits f√ºr einen Spin!';
                spinButton.disabled = true;
                return;
            }

            // Prestige Timer starten, wenn noch nicht gestartet
            if (!isTimingPrestige) {
                isTimingPrestige = true;
                prestigeStartTime = new Date().getTime();
                messageDisplay.textContent = '‚è±Ô∏è Prestige-Lauf gestartet!';
                // Starte den Timer-Update
                updateTimer(); 
            }
            
            // Kosten abziehen
            balance -= totalBet;
            isSpinning = true;
            spinButton.disabled = true;
            reelElements.forEach(cell => cell.classList.remove('win-highlight'));


            // 1. Walzen generieren
            slotResult = generateSlotResult();
            const spinDuration = getSpinDuration();
            const finalStopDuration = 500; // 0.5s f√ºr das sanfte Abbremsen

            
            // 2. Animation starten (schneller Roll-Teil)
            for (let reel = 0; reel < NUM_REELS; reel++) {
                const reelElement = document.getElementById(`cell-${1}-${reel}`); // Wir animieren nur die mittlere Reihe
                
                for (let row = 0; row < NUM_ROWS; row++) {
                    const cell = document.getElementById(`cell-${row}-${reel}`);
                    const innerDiv = cell.querySelector('.reel-inner');
                    
                    innerDiv.textContent = ''; 
                    
                    // Erzeuge eine lange Kette von Symbolen
                    let symbolStack = '';
                    const stackLength = 50; // Anzahl der Symbole im Stapel
                    for (let i = 0; i < stackLength; i++) {
                        symbolStack += getRandomSymbol() + '\n';
                    }
                    
                    // F√ºge die drei Ergebnisse (Oben, Mitte, Unten) hinzu
                    symbolStack += slotResult[0][reel] + '\n';
                    symbolStack += slotResult[1][reel] + '\n';
                    symbolStack += slotResult[2][reel]; 
                    innerDiv.textContent = symbolStack;
                    
                    // Starte die schnelle Animation mit Bewegungs-Unsch√§rfe
                    setTimeout(() => {
                        cell.classList.add('spinning');
                        innerDiv.classList.add('spinning-inner');
                        
                        // Setze die Transition des inneren Divs zur√ºck f√ºr den schnellen Start
                        innerDiv.style.transition = 'none';
                        // Starte die Animation (Keyframe-Loop)
                        innerDiv.style.animationPlayState = 'running';
                        
                    }, reel * 150); // Gestaffelter Start
                }
            }


            // 3. Ergebnis nach Spin-Dauer anzeigen (sanftes Abbremsen)
            for (let reel = 0; reel < NUM_REELS; reel++) {
                
                // Berechne den genauen Zeitpunkt f√ºr das Abbremsen jeder Walze
                const finalStopDelay = spinDuration + (reel * 150);
                
                // Warte, bis der Haupt-Spin jeder Walze vorbei ist
                setTimeout(() => {
                    
                    for (let row = 0; row < NUM_ROWS; row++) {
                        const cell = document.getElementById(`cell-${row}-${reel}`);
                        const innerDiv = cell.querySelector('.reel-inner');
                        
                        // 1. Stoppe die Keyframe-Animation
                        innerDiv.style.animationPlayState = 'paused';
                        
                        // 2. Setze die CSS-Transition f√ºr den Stop-Effekt
                        innerDiv.style.transition = `transform ${finalStopDuration}ms cubic-bezier(0.1, 0.9, 0.2, 1), filter 0.2s`; 
                        
                        // 3. Berechne die Endposition: Das Symbol slotResult[row][reel] muss im Fenster landen
                        const stackLength = 50;
                        let symbolIndex = stackLength + row;
                        let targetPosition = -symbolIndex * SYMBOL_HEIGHT;
                        
                        innerDiv.style.transform = `translateY(${targetPosition}px)`;
                        
                        // Entferne den Blur und die Spin-Klasse nach dem Abbremsen
                        setTimeout(() => {
                            cell.classList.remove('spinning');
                        }, finalStopDuration);

                    }

                }, finalStopDelay); // Die Zeit, bis die Walze stoppen soll (gestaffelt)
            }


            // 4. Ergebnis nach ABSCHLUSS der Animation berechnen und anzeigen
            setTimeout(() => {
                isSpinning = false;
                spinButton.disabled = false;
                
                // Setze die Anzeige in den Standard-Zustand zur√ºck, damit keine Animationen h√§ngen bleiben
                for (let reel = 0; reel < NUM_REELS; reel++) {
                    for (let row = 0; row < NUM_ROWS; row++) {
                        const cell = document.getElementById(`cell-${row}-${reel}`);
                        const innerDiv = cell.querySelector('.reel-inner');
                        
                        innerDiv.textContent = slotResult[row][reel]; 
                        innerDiv.style.animationPlayState = 'initial';
                        innerDiv.style.transition = 'none';
                        innerDiv.style.transform = 'translateY(0)'; 
                        cell.classList.remove('spinning'); 
                    }
                }
                
                const { totalWin, winningCells, didWin } = calculateWin(slotResult);
                let charmPointsGained = 0;


                if (didWin) {
                    balance += totalWin;
                    consecutiveLosses = 0;
                    consecutiveWins++;
                    messageDisplay.textContent = `üéâ GEWONNEN! ${totalWin} Credits!`;

                    // Charm Points durch Gewinn: 50 + 10 pro 100 Credits Gewinn
                    charmPointsGained = Math.min(50 + Math.floor(totalWin / 100) * 10, 300);

                    // Highlight Winning Cells
                    winningCells.forEach(([row, reel]) => {
                        document.getElementById(`cell-${row}-${reel}`).classList.add('win-highlight');
                    });
                    
                    // Free Upgrade Charm (Kostenloses Upgrade)
                    const winStreakThreshold = [0, 10, 5, 3][permanentCharms.freeUpgrade];
                    if (permanentCharms.freeUpgrade > 0 && consecutiveWins >= winStreakThreshold) {
                        charmPointsGained += 100;
                        messageDisplay.textContent += " (+100 P Free Upgrade!)";
                        consecutiveWins = 0; // Setze Z√§hler zur√ºck
                    }
                    

                } else {
                    // Niete
                    consecutiveLosses++;
                    consecutiveWins = 0;
                    
                    // Consolation Prize Charm (Trostpreis)
                    if (permanentCharms.consolationPrize > 0) {
                        const refund = [0, 10, 20, 30][permanentCharms.consolationPrize];
                        balance += refund;
                        messageDisplay.textContent = `üò≠ NIETE! Aber Trostpreis gibt dir ${refund} Credits zur√ºck.`;
                    } else {
                        messageDisplay.textContent = `üò≠ NIETE! Versuche es erneut.`;
                    }
                    
                    // Basispunkte f√ºr Niete
                    charmPointsGained = 5; 
                }

                
                // Charm Mastery (Mindestpunkte)
                const minCharmPoints = [5, 10, 15, 20][permanentCharms.charmMastery];
                charmPointsGained = Math.max(charmPointsGained, minCharmPoints);
                
                // Wealth Blessing (Guthaben-Bonus)
                if (permanentCharms.wealthBlessing > 0) {
                    const wealthBonus = Math.floor(balance / 50) * ([0, 1, 1.5, 2][permanentCharms.wealthBlessing]);
                    charmPointsGained += wealthBonus;
                }
                
                // Lucky Money (Charm-Punkte in Credits)
                if (permanentCharms.luckyMoney > 0) {
                    const creditBonus = Math.min(charmPointsGained * ([0, 1, 1.5, 2][permanentCharms.luckyMoney]), [0, 200, 300, 400][permanentCharms.luckyMoney]);
                    balance += creditBonus;
                    messageDisplay.textContent += ` (+${Math.round(creditBonus)} Credits Lucky Money)`;
                }
                
                // F√ºge die gesammelten Punkte hinzu
                charmPoints += Math.round(charmPointsGained);
                
                updateAllDisplays();

            }, spinDuration + (NUM_REELS * 150) + finalStopDuration); 

        }

        window.activatePrestige = function() {
            if (charmPoints < PRESTIGE_COST) {
                messageDisplay.textContent = `Du brauchst ${PRESTIGE_COST} Charm-Punkte, um Prestige zu aktivieren!`;
                return;
            }
            
            let timeElapsed = 0;
            if (isTimingPrestige && prestigeStartTime !== null) {
                const endTime = new Date().getTime();
                timeElapsed = endTime - prestigeStartTime;
                isTimingPrestige = false;
            }

            const timeMessage = timeElapsed > 0 ? `\n\nDeine Zeit f√ºr diesen Lauf: ${formatTime(timeElapsed)}` : '';
            if (!confirm(`Bist du sicher? Du verlierst ALLES, gewinnst aber Prestige Level ${prestigeLevel + 1} mit einem permanenten 10% Gewinn-Bonus!${timeMessage}`)) {
                return;
            }

            let newRecord = false;
            if (timeElapsed > 0) {
                const bestTime = localStorage.getItem('bestPrestigeTime');
                if (bestTime === null || timeElapsed < parseInt(bestTime)) {
                    localStorage.setItem('bestPrestigeTime', timeElapsed);
                    newRecord = true;
                }
            }

            prestigeLevel++;
            prestigeMultiplier += 0.10;
            lastChanceUsed = false;

            // Harter Reset
            balance = initialBalance;
            charmPoints = 0;
            consecutiveLosses = 0;
            consecutiveWins = 0;
            prestigeStartTime = null;

            permanentCharms = {
                luckyStart: 0, doubleDiamond: 0, antiLossBoost: 0,
                boostSymbol: 'üçí', charmMastery: 0, puritySevens: 0, wildGem: 0,
                lossStreakProtection: 0, luckyMoney: 0, freeUpgrade: 0,
                consolationPrize: 0, wealthBlessing: 0, lastChance: 0, speedBlessing: 0
            };

            updateAllDisplays();

            if (newRecord) {
                messageDisplay.textContent = `üèÜ NEUER REKORD! Prestige in ${formatTime(timeElapsed)}! Level ${prestigeLevel} Bonus: +${(prestigeMultiplier * 100).toFixed(0)}% Gewinne.`;
            } else {
                messageDisplay.textContent = `‚≠ê PRESTIGE AKTIVIERT! Zeit: ${formatTime(timeElapsed)}. Level ${prestigeLevel} Bonus: +${(prestigeMultiplier * 100).toFixed(0)}% Gewinne.`;
            }

            spinButton.disabled = false;
        }


        window.resetGame = function() {
            balance = initialBalance;
            charmPoints = 0;
            consecutiveLosses = 0;
            consecutiveWins = 0;
            lastChanceUsed = false;
            prestigeStartTime = null;
            isTimingPrestige = false;

            permanentCharms = {
                luckyStart: 0, doubleDiamond: 0, antiLossBoost: 0,
                boostSymbol: 'üçí', charmMastery: 0, puritySevens: 0, wildGem: 0,
                lossStreakProtection: 0, luckyMoney: 0, freeUpgrade: 0,
                consolationPrize: 0, wealthBlessing: 0, lastChance: 0, speedBlessing: 0
            };
            updateAllDisplays();

            messageDisplay.textContent = "Spiel neugestartet! Starte mit " + initialBalance + " Credits.";
            spinButton.disabled = false;
            reelElements.forEach(cell => {
                const innerDiv = cell.querySelector('.reel-inner');
                innerDiv.textContent = '?';
                innerDiv.classList.remove('spinning-inner');
                cell.classList.remove('win-highlight');
                cell.classList.remove('spinning');
                innerDiv.style.animationPlayState = 'initial';
                innerDiv.style.transition = 'none';
                innerDiv.style.transform = 'translateY(0)'; 
            });
        }

        function updateAllDisplays() {
            balanceDisplay.textContent = balance;
            charmPointsDisplay.textContent = charmPoints;
            consecutiveLossesDisplay.textContent = consecutiveLosses;
            prestigeLevelDisplay.textContent = `Prestige Level: ${prestigeLevel} (Bonus: +${(prestigeMultiplier * 100).toFixed(0)}%)`;
            
            // Bestzeit laden
            const bestTime = localStorage.getItem('bestPrestigeTime');
            bestTimeDisplay.textContent = bestTime ? `üèÜ Bestzeit: ${formatTime(parseInt(bestTime))}` : 'üèÜ Bestzeit: Keine';
            
            // Charm Status & Buttons
            for (const key in permanentCharms) {
                const level = permanentCharms[key];
                const statusElement = statusElements[`status${key.charAt(0).toUpperCase() + key.slice(1)}`];
                const buttonElement = buyButtons[`buy${key.charAt(0).toUpperCase() + key.slice(1)}`];
                
                if (statusElement) {
                    statusElement.textContent = level;
                    statusElement.classList.remove('max');
                    if (level === MAX_CHARM_LEVEL || (key === 'lastChance' && level === 1)) {
                        statusElement.classList.add('max');
                    }
                }

                if (buttonElement) {
                    if (level >= MAX_CHARM_LEVEL || (key === 'lastChance' && level === 1 && !lastChanceUsed)) {
                        buttonElement.disabled = true;
                        buttonElement.textContent = (key === 'lastChance' && !lastChanceUsed) ? 'EINMALIG GEKAUFT' : 'MAX LEVEL';
                    } else if (key === 'lastChance' && lastChanceUsed) {
                        buttonElement.disabled = true;
                        buttonElement.textContent = 'BEREITS EINGESETZT';
                    } else {
                        const nextCost = CHARM_DATA[key].cost[level];
                        buttonElement.disabled = charmPoints < nextCost;
                        buttonElement.textContent = `KAUFEN/UPGRADE (${nextCost} P)`;
                    }
                }
            }

            // Prestige Button Logik
            prestigeButton.disabled = charmPoints < PRESTIGE_COST;
            prestigeButton.textContent = `PRESTIGE AKTIVIEREN (${PRESTIGE_COST} P ben√∂tigt)`;
            
            // Anti-Loss Boost Logik (Anzeige und Auswahl)
            if (permanentCharms.antiLossBoost > 0) {
                boostSelectorDiv.style.display = 'block';
                boostedSymbolDisplay.textContent = permanentCharms.boostSymbol;
                boostSymbolSelector.value = permanentCharms.boostSymbol;
            } else {
                boostSelectorDiv.style.display = 'none';
                boostedSymbolDisplay.textContent = 'Keins';
            }
            
            spinButton.textContent = `DREHEN (${totalBet} Credits)`;
            document.getElementById('currentBet').textContent = totalBet;
        }

        // Timer-Funktion
        function updateTimer() {
            if (isTimingPrestige && prestigeStartTime !== null) {
                const now = new Date().getTime();
                const elapsed = now - prestigeStartTime;
                prestigeTimerDisplay.textContent = `‚è±Ô∏è Zeit bis Prestige: ${formatTime(elapsed)}`;
                // Ruft sich selbst alle 1 Sekunde auf
                setTimeout(updateTimer, 1000);
            } else if (prestigeStartTime === null) {
                prestigeTimerDisplay.textContent = '‚è±Ô∏è Zeit bis Prestige: Nicht gestartet';
            }
        }


        window.setBoostSymbol = function(symbol) {
            permanentCharms.boostSymbol = symbol;
            updateAllDisplays();
            messageDisplay.textContent = `Boost-Symbol auf ${symbol} gesetzt.`;
        }

        window.buyPermanentCharm = function(charmKey) {
            const level = permanentCharms[charmKey];
            if (level >= MAX_CHARM_LEVEL) return;

            const nextCost = CHARM_DATA[charmKey].cost[level];
            
            if (charmPoints >= nextCost) {
                if (charmKey === 'lastChance' && level === 1) return; // 'Last Chance' ist einmalig
                
                charmPoints -= nextCost;
                permanentCharms[charmKey]++;
                
                messageDisplay.textContent = `Charm **${charmKey.charAt(0).toUpperCase() + charmKey.slice(1)}** auf Level ${permanentCharms[charmKey]} upgegradet!`;
                
                updateAllDisplays();
            } else {
                messageDisplay.textContent = `Nicht genug Charm-Punkte! Ben√∂tigt: ${nextCost} P.`;
            }
        }

        window.showPermanentCharmInfo = function(charmKey) {
            const level = permanentCharms[charmKey];
            const nextLevel = level + 1;
            
            let currentDesc = level > 0 ? `**Aktuell (Lvl ${level}):** ${CHARM_DATA[charmKey].desc[level - 1]} ` : `Noch nicht gekauft.`;
            let statusText = "";

            if (level === MAX_CHARM_LEVEL || (charmKey === 'lastChance' && level === 1)) {
                statusText = " (MAX LEVEL)";
            } else {
                const nextCost = CHARM_DATA[charmKey].cost[level];
                const nextDesc = CHARM_DATA[charmKey].desc[level];
                
                statusText = ` | **N√§chster Kauf (Lvl ${nextLevel}, ${nextCost} P):** ${nextDesc}`;
            }
            
            charmDescriptionDisplay.innerHTML = `${currentDesc}${statusText}`;
        }

        window.clearCharmInfo = function() {
            charmDescriptionDisplay.textContent = "Klicke auf einen Charm, um die Beschreibung zu sehen!";
        }

        // Initialisierung
        createSlotField();
        populateBoostSelector();
        updateAllDisplays();
        // --- ENDE JAVASCRIPT LOGIK ---
    </script>

</body>
</html>